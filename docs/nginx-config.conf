server {
    listen 80;
    server_name ev.local; # 替换为您的域名
    
    # 网站根目录
    root /var/www/my_webapp/www;
    index index.php;
    
    # 增加路径前缀配置 - 适应YunoHost环境
    location /web/ {
        alias /var/www/my_webapp/www/;
        
        # URL重写规则
        location ~ ^/web/view/([^/]+)/?$ {
            try_files $uri $uri/ /frontend/views/$1.php?$args;
        }
        
        location ~ ^/web/api/([^/]+)/?$ {
            try_files $uri $uri/ /backend/api/api.php?endpoint=$1&$args;
        }
        
        location ~ ^/web/api/([^/]+)/([^/]+)/?$ {
            try_files $uri $uri/ /backend/api/api.php?endpoint=$1&id=$2&$args;
        }
        
        # 处理PHP文件
        location ~ \.php$ {
            include snippets/fastcgi-php.conf;
            fastcgi_pass unix:/var/run/php/php7.4-fpm.sock; # 根据您的PHP版本调整
            fastcgi_param SCRIPT_FILENAME $request_filename;
            include fastcgi_params;
        }
        
        # 防止访问.htaccess和其他隐藏文件
        location ~ /\. {
            deny all;
        }
    }
    
    # 重定向根目录到web子目录
    location = / {
        return 301 /web/;
    }
    
    # 处理根目录下的PHP文件
    location ~ ^/([^/]+\.php)$ {
        alias /var/www/my_webapp/www/$1;
        
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/var/run/php/php7.4-fpm.sock; # 根据您的PHP版本调整
        fastcgi_param SCRIPT_FILENAME $request_filename;
        include fastcgi_params;
    }
    
    # 静态文件缓存设置
    location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
        expires 30d;
        add_header Cache-Control "public, no-transform";
    }
    
    # 错误页面
    error_page 404 /frontend/views/404.php;
    error_page 500 502 503 504 /frontend/views/500.php;
} 